<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="465px" preserveAspectRatio="none" style="width:588px;height:465px;background:#FFFFFF;" version="1.1" viewBox="0 0 588 465" width="588px" zoomAndPan="magnify"><defs/><g><rect height="29.0679" style="stroke:#00000000;stroke-width:1.0;fill:none;" width="114" x="230.2428" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="104" x="235.2428" y="24.9659">Trojan 工作原理</text><ellipse cx="315.4857" cy="56.0679" fill="#222222" rx="10" ry="10" style="stroke:none;stroke-width:1.0;"/><g id="Nginx入口"><rect fill="#F1F1F1" height="58.1358" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="192" x="219.4857" y="127.0679"/><line style="stroke:#181818;stroke-width:0.5;" x1="219.4857" x2="411.4857" y1="156.1358" y2="156.1358"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="281.4857" y="147.0339">Nginx入口</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="172" x="224.4857" y="176.1018">根据 SNI 判断被访问的域名</text></g><g id="Trojan服务端"><rect fill="#F1F1F1" height="58.1358" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="197" x="93.9857" y="264.0679"/><line style="stroke:#181818;stroke-width:0.5;" x1="93.9857" x2="290.9857" y1="293.1358" y2="293.1358"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="85" x="149.9857" y="284.0339">Trojan服务端</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="177" x="98.9857" y="313.1018">判断是否 Trojan 客户端流量</text></g><g id="Nginx反向代理"><rect fill="#F1F1F1" height="58.1358" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="226" x="355.4857" y="264.0679"/><line style="stroke:#181818;stroke-width:0.5;" x1="355.4857" x2="581.4857" y1="293.1358" y2="293.1358"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="96" x="420.4857" y="284.0339">Nginx反向代理</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="206" x="360.4857" y="313.1018">根据 server_name 判断反代服务</text></g><g id="Return"><rect fill="#F1F1F1" height="58.1358" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:0.5;" width="132" x="279.4857" y="401.0679"/><line style="stroke:#181818;stroke-width:0.5;" x1="279.4857" x2="411.4857" y1="430.1358" y2="430.1358"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="46" x="322.4857" y="421.0339">Return</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="112" x="284.4857" y="450.1018">返回正常后端服务</text></g><ellipse cx="20.4857" cy="430.0679" fill="none" rx="10" ry="10" style="stroke:#222222;stroke-width:1.0;"/><ellipse cx="20.9857" cy="430.5679" fill="#222222" rx="6" ry="6" style="stroke:none;stroke-width:1.0;"/><!--MD5=[0b990d090a25696ff1b2bdf1a7bcadc8]
link *start to Nginx入口--><g id="link_*start_Nginx入口"><path d="M315.4857,66.1079 C315.4857,78.6379 315.4857,101.9479 315.4857,121.5579 " fill="none" id="*start-to-Nginx入口" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="315.4857,126.7179,319.4857,117.7179,315.4857,121.7179,311.4857,117.7179,315.4857,126.7179" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[5a36d8d596429679b7be0a17d1d683ad]
link Nginx入口 to Trojan服务端--><g id="link_Nginx入口_Trojan服务端"><path d="M289.7057,185.3679 C269.8557,207.1479 242.4157,237.2579 221.7557,259.9479 " fill="none" id="Nginx入口-to-Trojan服务端" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="218.2357,263.8079,227.2541,259.8495,221.6033,260.1121,221.3408,254.4613,218.2357,263.8079" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="52" x="261.4857" y="229.9649">魔法域名</text></g><!--MD5=[a878e48e0da71bc99d71d1a0f72e7e4a]
link Nginx入口 to Nginx反向代理--><g id="link_Nginx入口_Nginx反向代理"><path d="M347.5557,185.3679 C372.4257,207.3079 406.8857,237.7179 432.6557,260.4579 " fill="none" id="Nginx入口-to-Nginx反向代理" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="436.7157,264.0379,432.6294,255.0767,432.9724,260.7232,427.3259,261.0661,436.7157,264.0379" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="52" x="401.4857" y="229.9649">其他域名</text></g><!--MD5=[79825e8aedf75fbcde1eee98a6402f17]
link Trojan服务端 to Return--><g id="link_Trojan服务端_Return"><path d="M181.4857,322.3879 C177.3457,338.0479 175.6957,357.1079 185.4857,371.0679 C205.6157,399.7679 241.4557,414.3279 274.1157,421.6879 " fill="none" id="Trojan服务端-to-Return" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="279.3257,422.8079,271.359,417.0173,274.4359,421.7642,269.689,424.8411,279.3257,422.8079" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="264" x="186.4857" y="366.9649">否，转发到 http://remote_addr:remote_port</text></g><!--MD5=[4f0c4572f8009dcbd4a662ff2bf9bfb0]
link Trojan服务端 to *end--><g id="link_Trojan服务端_*end"><path d="M93.9757,314.8979 C73.2157,323.3879 53.1857,335.3179 38.4857,352.0679 C23.1157,369.5879 20.2157,397.7479 20.0057,414.7179 " fill="none" id="Trojan服务端-to-*end" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="20.0257,420.0179,24,411.0065,20.0114,415.0179,16,411.0294,20.0257,420.0179" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="130" x="39.4857" y="366.9649">是：打开互联网的大门</text></g><!--MD5=[9d57b914f737e71a0daef02506c8c062]
link Nginx反向代理 to Return--><g id="link_Nginx反向代理_Return"><path d="M471.3757,322.3379 C471.5457,337.9779 469.2557,357.0379 459.4857,371.0679 C448.8157,386.3879 432.8557,397.9079 416.2257,406.4579 " fill="none" id="Nginx反向代理-to-Return" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="411.5257,408.7979,421.365,408.3633,416.0007,406.5676,417.7964,401.2033,411.5257,408.7979" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="26" x="468.4857" y="366.9649">转发</text></g><!--MD5=[1a4f36506cf04e2151558c5dcdfdb386]
@startuml fuck-the-wall

title Trojan 工作原理

[*] - -> Nginx入口

Nginx入口 : 根据 SNI 判断被访问的域名
Nginx入口 - -> Trojan服务端 : 魔法域名
Nginx入口 - -> Nginx反向代理 : 其他域名

Trojan服务端 : 判断是否 Trojan 客户端流量
Trojan服务端 - -> Return : 否，转发到 http://remote_addr:remote_port
Trojan服务端 - -> [*] : 是：打开互联网的大门

Nginx反向代理 : 根据 server_name 判断反代服务
Nginx反向代理 - -> Return : 转发
Return : 返回正常后端服务

@enduml

PlantUML version 1.2022.6(Wed Jun 22 01:34:49 CST 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>